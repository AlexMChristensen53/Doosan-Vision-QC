from __future__ import annotations
import cv2 as cv
import numpy as np

from Vision_tools import load_image


try:
    from Vision_camera import OakCamera
    OAK_AVAILABLE = True
except ImportError:
    OakCamera = None
    OAK_AVAILABLE = False


def nothing(_):
    pass


def create_trackbars(window_name: str):
    """Create trackbars inside a persistent control window."""
    cv.namedWindow(window_name, cv.WINDOW_NORMAL)

    # Display scale
    cv.createTrackbar("scale %", window_name, 40, 100, nothing)

    # Blur kernel size
    cv.createTrackbar("blur k", window_name, 5, 31, nothing)

    # Threshold
    cv.createTrackbar("thresh", window_name, 120, 255, nothing)

    # Canny
    cv.createTrackbar("canny low", window_name, 50, 255, nothing)
    cv.createTrackbar("canny high", window_name, 150, 255, nothing)

    # Min area
    cv.createTrackbar("min area", window_name, 200, 10000, nothing)

    # HSV
    cv.createTrackbar("H low", window_name, 0, 179, nothing)
    cv.createTrackbar("H high", window_name, 179, 179, nothing)
    cv.createTrackbar("S low", window_name, 0, 255, nothing)
    cv.createTrackbar("S high", window_name, 255, 255, nothing)
    cv.createTrackbar("V low", window_name, 0, 255, nothing)
    cv.createTrackbar("V high", window_name, 255, 255, nothing)


def get_frame(source: str, filename: str | None, camera: "OakCamera | None"):
    """Gets a frame from either file or camera."""
    if source == "image":
        return load_image(filename)

    if source == "camera":
        if not OAK_AVAILABLE or camera is None:
            raise RuntimeError("Camera mode selected but OakCamera is not available.")
        return camera.get_frame()

    raise ValueError(f"Invalid source: {source}")


def vision_settings(source: str = "image",
                    filename: str | None = None):
    """
    Interactive GUI for tuning HSV, Canny, blur, threshold, area filtering.
    Press ESC or 'q' to exit.
    """

    # ---------------------------------------------------
    # 1. Camera initialization (if needed)
    # ---------------------------------------------------
    camera = OakCamera() if (source == "camera" and OAK_AVAILABLE) else None

    if source == "image":
        if not filename:
            raise ValueError("filename is required when source='image'")
        base_frame = load_image(filename)
    else:
        base_frame = None

    # ---------------------------------------------------
    # 2. Create CONTROL window and all other windows FIRST
    # ---------------------------------------------------
    control_window = "controls"
    create_trackbars(control_window)

    # Pre-create ALL image display windows here (important)
    windows = ["Frame", "Mask", "Gray", "Thresh", "Edges", "Overlay"]
    for win in windows:
        cv.namedWindow(win, cv.WINDOW_NORMAL)

    # ---------------------------------------------------
    # 3. Processing loop
    # ---------------------------------------------------
    while True:

        # Get frame
        if source == "image":
            frame = base_frame.copy()
        else:
            frame = get_frame(source, filename, camera)

        # ROI cropping â€” SAME as before
        x1, x2 = 380, 1478
        y1, y2 = 143, 872
        frame = frame[y1:y2, x1:x2]

        # Read trackbar values
        scale = max(10, cv.getTrackbarPos("scale %", control_window)) / 100.0

        blur_kernel = cv.getTrackbarPos("blur k", control_window)
        blur_kernel = blur_kernel if blur_kernel % 2 == 1 else blur_kernel + 1
        blur_kernel = max(1, blur_kernel)

        thresh_val = cv.getTrackbarPos("thresh", control_window)
        canny_low = cv.getTrackbarPos("canny low", control_window)
        canny_high = cv.getTrackbarPos("canny high", control_window)
        if canny_high <= canny_low:
            canny_high = canny_low + 1

        min_area = cv.getTrackbarPos("min area", control_window)

        H_low = cv.getTrackbarPos("H low", control_window)
        H_high = cv.getTrackbarPos("H high", control_window)
        S_low = cv.getTrackbarPos("S low", control_window)
        S_high = cv.getTrackbarPos("S high", control_window)
        V_low = cv.getTrackbarPos("V low", control_window)
        V_high = cv.getTrackbarPos("V high", control_window)

        # Resize for display
        h, w = frame.shape[:2]
        frame_small = cv.resize(frame, (int(w * scale), int(h * scale)))

        # HSV mask
        hsv = cv.cvtColor(frame_small, cv.COLOR_BGR2HSV)
        lower = np.array([H_low, S_low, V_low], dtype=np.uint8)
        upper = np.array([H_high, S_high, V_high], dtype=np.uint8)

        mask = cv.inRange(hsv, lower, upper)
        masked = cv.bitwise_and(frame_small, frame_small, mask=mask)

        # Gray + blur
        gray = cv.cvtColor(masked, cv.COLOR_BGR2GRAY)
        blur = cv.GaussianBlur(gray, (blur_kernel, blur_kernel), 0)

        # Threshold + edges
        _, thres = cv.threshold(blur, thresh_val, 255, cv.THRESH_BINARY_INV)
        edges = cv.Canny(blur, canny_low, canny_high)

        # Contours
        contours, _ = cv.findContours(edges, cv.RETR_LIST, cv.CHAIN_APPROX_SIMPLE)
        big_contours = [c for c in contours if cv.contourArea(c) >= min_area]

        overlay = frame_small.copy()
        cv.drawContours(overlay, big_contours, -1, (0, 0, 255), 2)

        # Print debug info
        print(f"\rContours: {len(big_contours)} | "
              f"scale={scale:.2f}, blur={blur_kernel}, "
              f"thr={thresh_val}, canny=({canny_low},{canny_high}), "
              f"min_area={min_area}", end="")

        # ---------------------------------------------------
        # 4. Show frames (windows already exist)
        # ---------------------------------------------------
        cv.imshow("Frame", frame_small)
        cv.imshow("Mask", mask)
        cv.imshow("Gray", gray)
        cv.imshow("Thresh", thres)
        cv.imshow("Edges", edges)
        cv.imshow("Overlay", overlay)

        # ---------------------------------------------------
        # 5. Exit key handling
        # ---------------------------------------------------
        key = cv.waitKey(1) & 0xFF
        if key in (27, ord('q')):
            break

    print()
    cv.destroyAllWindows()


if __name__ == "__main__":
    vision_settings("image", "frame_1764083636036.png")
